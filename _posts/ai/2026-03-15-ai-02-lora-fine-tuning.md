---
layout: post
title:  "LoRA??LLM ???逾??類ｋ뻤???얄뵛: ??關紐??⑤챷逾?嶺뚮ㅄ維?????덈? ?띠럾????獄?
date:   2025-02-20 09:00:00 +0900
categories: [IT, AI]
tags: [AI, LLM, LoRA, ???逾??類ｋ뻤, fine-tuning, Qwen, PEFT]
description: "LoRA???????琉우뿰 LLM????關紐??⑤챷紐드슖????逾??類ｋ뻤??濡ル츎 ?꾩렮維뽬떋???꾩룄????? ???깆젷 ?袁⑤?獄????깆젷?????????節띉濡⑦돦熬곣뫁夷???袁⑦돵??紐껊퉵??"
---

# LoRA??LLM ???逾??類ｋ뻤???얄뵛: ??關紐??⑤챷逾?嶺뚮ㅄ維?????덈? ?띠럾????獄?

???잙?裕???筌뤾쑬??嶺뚮ㅄ維??LLM)?????逾??類ｋ뻤??濡ル츎 ?롪퍒?? ??????嶺뚮씭?????ル봾堉? ?熬곣뫕??嶺뚮ㅄ維??????덈????ろ뀞???좊듆 ??濡れ뻑 GB??GPU 嶺뚮∥???꾨뎨?? ?熬곣뫗????겶? ???덈? ??蹂?뜟?????댁굥 濾곌쑬梨??? 

LoRA(Low-Rank Adaptation)?????????쒖굣?節뉖ご????㏉뜖??濡ル츎 ??關紐??⑤챷逾????逾??類ｋ뻤 ?リ옇?↑떋????? ?熬곣뫕??嶺뚮ㅄ維??????덈????ろ뀞?????? ??? ?????????깅턄???壤????덈???戮깅짉??嶺뚮∥???꾨뎨???????沅????덈? ??蹂?뜟??????繞벿븐뫒???

???リ섣??????????깆젷 ?袁⑤?獄?쓣紐??????LoRA ???逾??類ｋ뻤???熬곣뫕????λ닔?????節띉濡⑦돦熬곣뫁夷???袁⑥젷?곌랜??뜎??

## LoRA?? ??쒕샍驪?筌??

LoRA??嶺뚮ㅄ維????띠럾?繞벿살탳?洹욌ご?嶺뚯쉳?????瑜곸젧??濡ル츎 ???? **??嶺뚢뼰維????怨쀬죯???怨뺣뼺?**??琉우뿰 嶺뚮ㅄ維?????⑤챷踰???ろ뀞???リ옇?↑떋????? 

??????띠럾?繞벿살탳????怨쀬죯 W?????깅쾳???띠룇????釉뚯뫓???類ｋ펲:

```
W' = W + ?W
?W = BA (B??r??, A??d?????怨쀬죯, r << d)
```

?????r?? rank?? ?곌랜???8~64 ???????? ?띠룆???? ????猿껋물???濡?듆 ???덈???怨룻뒍 ??濡ル츎 ???逾ф쾬?롮구????? ?リ옇?ч뇡?臾?源낅빢??⑤챷紐드슖?繞벿븐뫒???ル봾堉?

## ?熬곣뫕???袁⑤?獄???뚮벣??

?袁⑤?獄?????????깅쾳???띠룇?? ??節띉濡?뿉???뚮봽???類ｋ펲:

1. ??⑥щ턄???β돦裕녻キ????熬곣뫗???
2. 嶺뚮ㅄ維??????ルㅎ苡??瑜곷턄?? ?β돦裕녻キ?
3. LoRA ???깆젧 ??⑤챷??
4. ???덈? ???깆젧 ?????덈뺄
5. 嶺뚮ㅄ維??????

????節띉濡㏓ご?????????袁⑥젷?곌랜???

## 1. ?熬곣뫗?????源녿턄??곗뒧??逾??熬곥굥竊??

```python
import argparse
import json
import os
from pathlib import Path

import torch
from datasets import Dataset
from peft import LoraConfig, get_peft_model
from transformers import AutoModelForCausalLM, Autotokizer
from trl import SFTConfig, SFTTrainer
```

- **argparse**: 嶺뚮ㅏ援앲??얜뭄??筌뤾쑴?????堉?
- **torch**: PyTorch (?縕????熬곣뫁??熬곣뫗???
- **datasets**: Hugging Face ??⑥щ턄??⑥ヂ???源녿턄??곗뒧??逾?
- **peft**: Parameter-Efficient Fine-Tuning ??源녿턄??곗뒧??逾?(LoRA ????
- **transformers**: Hugging Face??嶺뚮ㅄ維????ルㅎ苡??瑜곷턄?? ??源녿턄??곗뒧??逾?
- **trl**: Transformer Reinforcement Learning (SFTTrainer ????

## 2. ??⑥щ턄???β돦裕녻キ???貫??

```python
def load_jsonl(path: Path) -> list[dict]:
    items = []
    with path.open("r", encoding="utf-8") as f:
        for line in f:
            if line.strip():
                items.append(json.loads(line))
    return items
```

????貫???JSONL(JSON Lines) ?筌먦끇六?????逾?????덈츎?? JSONL?? ??繞벿븐뫒?????몃뎡??⑤챷逾?JSON ?띠룇鍮섊뙼???筌먦끇六?????

**???곕뻣 JSONL ???逾?**
```
{"messages": [{"role": "user", "content": "???댟?}, {"role": "assistant", "content": "???댟??琉얠돪??"}]}
{"messages": [{"role": "user", "content": "???逾?????紐꺟딃뜮?"}, {"role": "assistant", "content": "?熬곣뫁夷?윜諛몄굡?誘?낯??筌뤾쑬????낅퉵??"}]}
```

??繞벿븐뫒??????꽑??JSON??怨쀬Ŧ ???堉???겶??洹먮봾裕?筌뤾쑬???怨뺣뼺???類ｋ펲.

## 3. 嶺???????ロ깵???곌떠?????貫??

```python
def build_chat_text(example: dict, tokizer: Autotokizer) -> str:
    """
    messages = [
      {"role": "user", "content": "..."},
      {"role": "assistant", "content": "..."}
    ]
    """
    messages = example["messages"]

    # Qwen / LLaMA ??ｌ뫒??chat template ????
    text = tokizer.apply_chat_template(
        messages,
        tokize=False,
        add_generation_prompt=False,
    )
    return text
```

????貫???嶺?????筌먦끇六??嶺뚮∥???낆????嶺뚮ㅄ維?????袁⑦돵???????덈츎 ???⑸츩?筌뤾퍔夷??곌떠???臾먮┰??

**???놁졑 ???곕뻣:**
```python
{
    "messages": [
        {"role": "user", "content": "???댟??琉얠돪??},
        {"role": "assistant", "content": "???댟??琉얠돪?? ??쒕샍驪???熬???類싲뎅濚밸Ŧ???"}
    ]
}
```

**?怨쀫츊?????곕뻣 (Qwen ???ロ깵??:**
```
<|im_start|>user
???댟??琉얠돪??|im_end|>
<|im_start|>assistant
???댟??琉얠돪?? ??쒕샍驪???熬???類싲뎅濚밸Ŧ???<|im_end|>
```

`apply_chat_template`?? 嶺뚮ㅄ維???嶺뚮씮????獄?????ルㅎ荑?????吏??怨쀬Ŧ ?怨뺣뼺?????? `tokize=False`?????⑸츩????쒖굣???怨몃굵 ?꾩룇瑗????겶? `add_generation_prompt=False`????諛댁뎽 ?熬곣뫅??熬곥굥諭???怨뺣뼺???? ???낅츎??

## 4. 嶺뚮∥?????貫?? ?筌뤾쑴?????堉?

```python
def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--base_model", default="Qwen/Qwen2.5-7B-Instruct")
    parser.add_argument("--train_path", required=True)
    parser.add_argument("--eval_path", default="")
    parser.add_argument("--output_dir", required=True)

    parser.add_argument("--max_seq_length", type=int, default=2048)
    parser.add_argument("--learning_rate", type=float, default=1e-4)
    parser.add_argument("--num_train_epochs", type=int, default=3)
    parser.add_argument("--batch_size", type=int, default=1)
    parser.add_argument("--gradient_accumulation_steps", type=int, default=4)
    parser.add_argument("--save_steps", type=int, default=100)
    parser.add_argument("--logging_steps", type=int, default=10)
    parser.add_argument("--seed", type=int, default=42)

    # LoRA
    parser.add_argument("--lora_r", type=int, default=16)
    parser.add_argument("--lora_alpha", type=int, default=32)
    parser.add_argument("--lora_dropout", type=float, default=0.05)

    args = parser.parse_args()
```

嶺뚮ㅏ援앲??얜뭄??筌뤾쑴????筌먦끉踰??類ｋ펲. ?낅슣????筌뤾쑴???

- **base_model**: ???逾??類ｋ뻤???リ옇???嶺뚮ㅄ維??(?リ옇???泥? Qwen2.5-7B-Instruct)
- **train_path**: ???덈? ??⑥щ턄???롪퍔?δ빳?(?熬곣뫖??
- **eval_path**: ??? ??⑥щ턄???롪퍔?δ빳?(??ルㅎ臾?
- **output_dir**: 嶺뚮ㅄ維???????롪퍔?δ빳?(?熬곣뫖??
- **max_seq_length**: 嶺뚣끉裕? ???궰????ル梨??(??ルㅎ荑???
- **learning_rate**: ???덈???
- **num_train_epochs**: ???덈? ??믨퀡竊????
- **batch_size**: ?꾩룄???????
- **gradient_accumulation_steps**: ?잙갭梨???븐슜????熬곣뫗?????댟?(嶺뚮∥???꾨뎨??遊붋????????
- **lora_r**: LoRA rank (?????濡?Ŋ ???逾ф쾬?롮구????⑤챷踰? ?リ옇???泥?16)
- **lora_alpha**: LoRA alpha (?????怨쀬땋 ???逾ф쾬?롮구?? ?リ옇???泥?32)
- **lora_dropout**: LoRA dropout ?????

## 5. GPU 嶺뚮∥???꾨뎨?嶺뚣끉裕??????깆젧

```python
    os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "expandable_segments:True"
```

PyTorch??CUDA 嶺뚮∥???꾨뎨???ル봾堉??꾩렮維???嶺뚣끉裕???됀??? `expandable_segments`??嶺뚮∥???꾨뎨???????? 繞벿븐뫒???????關紐??⑤챷紐드슖?GPU 嶺뚮∥???꾨뎨?? ??????????쀬벟 ?????

## 6. ??ルㅎ苡??瑜곷턄?? ?β돦裕녻キ?

```python
    # tokizer ?誘る닔? ?β돦裕녻キ?(chat template ????
    tokizer = Autotokizer.from_pretrained(
        args.base_model,
        trust_remote_code=True,
    )
    tokizer.pad_tok = tokizer.eos_tok
    padding_side_value = "right"
    tokizer.padding_side = padding_side_value
```

??ルㅎ苡??瑜곷턄?????誘る닔? ?β돦裕녻キ??類ｋ펲. `trust_remote_code=True`??嶺뚮ㅄ維?????ｋ걠??? ?袁⑤?獄?쓣紐???????롪퍔??????덈뺄?????깅뮔??類ｋ펲.

**繞벿살탳??????깆젧:**
- `pad_tok = eos_tok`: ???삳럠 ??ルㅎ荑??EOS(End of Sequence) ??ルㅎ荑??怨쀬Ŧ ???깆젧. ??? 嶺뚮ㅄ維??? ???삳럠 ??ルㅎ荑????怨몃굵 ?????덈펲.
- `padding_side = "right"`: ???삳럠?????섎꿰춯?쏅윪???怨뺣뼺?. ???遊붋?釉뚯뫒??嶺뚮ㅄ維??????꾩렮維????????類ｋ펲.

## 7. ??⑥щ턄??⑥ヂ?繞벿뮻??

```python
    # dataset
    train_items = load_jsonl(Path(args.train_path))
    train_ds = Dataset.from_list(train_items)
    train_ds = train_ds.map(
        lambda ex: {"text": build_chat_text(ex, tokizer)},
        remove_columns=train_ds.column_names,
    )
```

???덈? ??⑥щ턄??? ?β돦裕녻キ???겶??熬곣뫗??洹먮뿫由??

1. JSONL ???逾??????꽑???洹먮봾裕?筌뤾퍔夷??곌떠???
2. Hugging Face Dataset ?띠룇鍮섊뙼?륁뿉??곌떠???
3. ?????깆젷??嶺???????ロ깵???筌먦끇六??怨쀬Ŧ ?곌떠???
4. ???沅???롫맩????蹂ㅽ깴 (嶺뚮∥???꾨뎨????고뒎)

**?곌떠?????λ닔??**
```
???沅? {"messages": [...]}
     ??
?곌떠??? {"text": "<|im_start|>user\n???댟?|im_end|>\n..."}
```

??? ??⑥щ턄??⑤베利????됰뎄???꾩렮維???怨쀬Ŧ 嶺뚳퐣瑗???類ｋ펲:

```python
    eval_ds = None
    if args.eval_path:
        eval_items = load_jsonl(Path(args.eval_path))
        if eval_items:
            eval_ds = Dataset.from_list(eval_items)
            eval_ds = eval_ds.map(
                lambda ex: {"text": build_chat_text(ex, tokizer)},
                remove_columns=eval_ds.column_names,
            )
```

## 8. ?リ옇???嶺뚮ㅄ維???β돦裕녻キ?

```python
    # base model
    model = AutoModelForCausalLM.from_pretrained(
        args.base_model,
        torch_dtype=torch.float16,
        device_map="auto",
        trust_remote_code=True,
    )
```

?リ옇???嶺뚮ㅄ維????β돦裕녻キ??類ｋ펲:

- **torch_dtype=torch.float16**: ?꾩룇瑗??껋낯???float16) ?????怨쀬Ŧ 嶺뚮∥???꾨뎨?????????됰틮??怨쀬Ŧ ?띠룆흮??
- **device_map="auto"**: ???吏??怨쀬Ŧ GPU/CPU??嶺뚮ㅄ維????釉뚯뫒亦??꾩룄???(嶺뚮졋???GPU 嶺뚯솘???
- **trust_remote_code=True**: ??ｋ걠??? 嶺뚮ㅄ維???袁⑤?獄????덈뺄 ???깅뮔

## 9. LoRA ???깆젧 ??⑤챷??

```python
    # LoRA
    peft_config = LoraConfig(
        r=args.lora_r,
        lora_alpha=args.lora_alpha,
        lora_dropout=args.lora_dropout,
        bias="none",
        task_type="CAUSAL_LM",
        target_modules=[
            "q_proj", "k_proj", "v_proj",
            "o_proj", "gate_proj",
            "up_proj", "down_proj",
        ],
    )
    model = get_peft_model(model, peft_config)
    model.print_trainable_parameters()
```

LoRA ???깆젧???筌먦끉踰???겶?嶺뚮ㅄ維?????⑤챷???類ｋ펲:

**LoRA ???逾ф쾬?롮구?????닿뎄:**
- **r (rank)**: ??嶺뚢뼰維????怨쀬죯??嶺뚢뼰維?? ??얜?諭??濡?Ŋ ???逾ф쾬?롮구?묕퐛泥? ???嶺????ш껑??????貫?좂춯??????깅쾳 (?リ옇???泥? 16)
- **lora_alpha**: LoRA ?띠럾?繞벿살탳????????怨쀬땋 ??釉뚯댉. ?곌랜???r??2?꾩룄?▽빳????깆젧 (?リ옇???泥? 32)
- **lora_dropout**: ??類싲뙓?熬곣뫗??????? ??λ닔????꾩렮維? (?リ옇???泥? 0.05)
- **bias**: bias ???덈? ???. "none"?? ???덈???? ???곷쾳
- **task_type**: ??얜?????ル쪇援? "CAUSAL_LM"?? ?筌뤾쑬??嶺뚮ㅄ維??숈춹?
- **target_modules**: LoRA????⑤챷???嶺뚮ㅄ維獄? Attention??FFN???낅슣??????깅턄???獄?

**target_modules ???닿뎄:**
- `q_proj`, `k_proj`, `v_proj`: Query, Key, Value ?熬곣뫁夷??諛맞?(Attention)
- `o_proj`: Output ?熬곣뫁夷??諛맞?(Attention)
- `gate_proj`, `up_proj`, `down_proj`: Feed-Forward Network ???깅턄??

`get_peft_model`??嶺뚮ㅄ維?????臾먮쫭??濡?듆, 嶺뚯솘??筌먲퐢彛?嶺뚮ㅄ維獄???異?LoRA ???깅턄??? ?怨뺣뼺???類ｋ펲. `print_trainable_parameters()`?????덈? ?띠럾??繞③뇡????逾ф쾬?롮구????? ?怨쀫츊???類ｋ펲.

**???곕뻣 ?怨쀫츊??**
```
trainable params: 8,388,608 || all params: 6,738,415,616 || trainable%: 0.12
```

?熬곣뫕??嶺뚮ㅄ維???0.12%嶺????덈??????嶺뚮∥???꾨뎨?? ??蹂?뜟?????????고뒎??類ｋ펲.

## 10. ???덈? ???깆젧

```python
    # SFT config
    training_args = SFTConfig(
        output_dir=args.output_dir,
        dataset_text_field="text",
        max_length=args.max_seq_length,
        packing=False,
        num_train_epochs=args.num_train_epochs,
        per_device_train_batch_size=args.batch_size,
        gradient_accumulation_steps=args.gradient_accumulation_steps,
        optim="paged_adamw_32bit",
        save_steps=args.save_steps,
        logging_steps=args.logging_steps,
        learning_rate=args.learning_rate,
        warmup_ratio=0.03,
        lr_scheduler_type="cosine",
        seed=args.seed,
        report_to=[],
    )
```

SFT(Supervised Fine-Tuning) ???덈? ???깆젧:

**?낅슣??????깆젧:**
- **dataset_text_field**: ??⑥щ턄??⑥ヂ?????????????⑸츩???熬곣뫀援←춯?
- **max_length**: 嶺뚣끉裕? ???궰????ル梨??(??ルㅎ荑???
- **packing**: ???????깆젷????濡る룎?????궰????댁Ŧ ??????? ??? (False???????깆젷?????몃뎡??⑤챷紐드슖?嶺뚳퐣瑗??
- **per_device_train_batch_size**: ??븐뼚類??怨룸츩???꾩룄???????
- **gradient_accumulation_steps**: ?잙갭梨???븐슜????熬곣뫗?? ?꾩룄??????깃퀋紐???節뗪땁??⑤챷紐드슖????깅뮲 ?????깅쾳
  - ???깆젷 ?꾩룄???????= batch_size ??gradient_accumulation_steps ??num_gpus
- **optim**: ???堉믥춯?얜쐠???. "paged_adamw_32bit"??嶺뚮∥???꾨뎨???關紐??⑤챷逾?AdamW
- **warmup_ratio**: ???鍮???????(?熬곣뫕?????댟??3%)
- **lr_scheduler_type**: ???덈??????繞벿븐뫊?? "cosine"?? ?袁⑤뾼亦???띠룆흮??
- **report_to**: ?β돦裕??????(???洹먮봾裕?筌뤾퍓裕??β돦裕??????

## 11. ?筌뤾퍔????????諛댁뎽 ?????덈?

```python
    trainer = SFTTrainer(
        model=model,
        tokizer=tokizer,
        train_dataset=train_ds,
        eval_dataset=eval_ds,
        peft_config=peft_config,
        args=training_args,
    )

    print("Starting chat SFT training...")
    trainer.train()
```

SFTTrainer????諛댁뎽???겶????덈?????戮곗굚??類ｋ펲. SFTTrainer??Hugging Face??Trainer???筌먦끉???琉우뿰 ???⑸츩????諛댁뎽 嶺뚮ㅄ維?????덈???嶺뚣끉裕???븐뼔彛??リ옇??????蹂κ텢??類ｋ펲.

???덈?????戮곗굚??濡?듆 ???깅쾳???띠룇?? ?筌먲퐢沅뽪뤆?쎛 ?怨쀫츊???類ｋ펲:
- ???덈? ???堉?(loss)
- ???덈???(learning rate)
- ???덈? ???쒖┣ (samples/sec)
- ??? ??蹂?뜟 (estimated time)

## 12. 嶺뚮ㅄ維??????

```python
    out_dir = Path(args.output_dir)
    out_dir.mkdir(parents=True, exist_ok=True)
    trainer.model.save_pretrained(out_dir)
    tokizer.save_pretrained(out_dir)
```

???덈????熬곣뫁???濡?듆 嶺뚮ㅄ維??맞???ルㅎ苡??瑜곷턄???????繞③뇡?? LoRA 嶺뚮ㅄ維??? ?リ옇???嶺뚮ㅄ維??맞????????띠럾?繞벿살탳?洹⑥춹????縕ョ뵳釉껋쾵?????紐꾩럸??嶺뚮씞?????얜Ŧ堉?(?곌랜?????琉용폀 MB).

## ???????곕뻣

?袁⑤?獄?쓣紐????덈뺄??濡ル츎 ?꾩렮維뽬떋?

```bash
python train_lora.py \
    --base_model Qwen/Qwen2.5-7B-Instruct \
    --train_path data/train.jsonl \
    --eval_path data/eval.jsonl \
    --output_dir ./output \
    --max_seq_length 2048 \
    --learning_rate 1e-4 \
    --num_train_epochs 3 \
    --batch_size 1 \
    --gradient_accumulation_steps 4 \
    --lora_r 16 \
    --lora_alpha 32
```

## LoRA ???逾ф쾬?롮구????類ｋ뻤 ?띠럾????獄?

**rank (r) ??ルㅎ臾?**
- **r=8**: 嶺뚮씞?????? ???逾ф쾬?롮구?? ??伊?????덈?, ??? ???ш껑??
- **r=16**: ?잙?伊????щ옌 ??ルㅎ臾?(?リ옇???泥?
- **r=32**: ??嶺뚮씭?? ???逾ф쾬?롮구?? ???沃? ???ш껑??
- **r=64**: 嶺뚮씭?? ???逾ф쾬?롮구?? ?沃? ???ш껑?? ???逾????덈?

**alpha ??ルㅎ臾?**
- ?곌랜???r??2?꾩룄?▽빳????깆젧 (r=16?????alpha=32)
- alpha?띠럾? ??怨룸빢??LoRA ?띠럾?繞벿살탳?????⑤갭?????ｋ걠壤?

**嶺뚮∥???꾨뎨??遊붋????**
- `batch_size`??1?????깆젧
- `gradient_accumulation_steps`????濡?졎?????깆젷 ?꾩룄??????????
- `max_seq_length`??繞벿븐뫒??
- `lora_r`??繞벿븐뫒??

## ?熬곣뫕???袁⑤?獄?

?熬곣뫕???袁⑤?獄???熬곣뫗踰???節띉???깅굵 嶺뚮ㅄ維筌??????類ｋ펲. ???遊붋?釉뚯뫒??????됰ŀ移???⑤슡???濡ル츎嶺뚯솘? ??袁⑦돵??濡?듆, ???六욜춯?얠뒩?????逾??類ｋ뻤 ???逾?熬곣뫁逾?筌뤾쑴諭???뚮뵁????????덈펲.

## ?롪퍒?▽빳?

LoRA???????濡?듆 ?熬곣뫕??嶺뚮ㅄ維??????덈????ろ뀞???롪퍒??????貫????? ?洹먮봾爰???댁Ŧ LLM?????逾??類ｋ뻤???????덈펲. ???袁⑤?獄?????깆젷 ?熬곣뫁夷?筌먦끇????????????????덈츎 ??????熬곣뫗??????깆젷??

?낅슣???????
- **嶺뚮∥???꾨뎨???關紐?*: ?熬곣뫕??嶺뚮ㅄ維??????1% 亦껋꼶梨뜹퐲?????逾ф쾬?롮구?묕퐦彛????덈?
- **???덈? ???쒖┣**: ??伊????濡?（??嶺뚯쉧猷? ???덈? ??蹂?뜟
- **??ル∥???*: ??????얜??????????類ㅼŦ ???섎?LoRA ??????? ???덈? ?띠럾???
- **?筌뤿굞???*: ?リ옇???嶺뚮ㅄ維??? ?잙갭梨????????濡?듆????????⑤벡異???흮???띠럾???

???袁⑤?獄?쓣紐??リ옇?↑??怨쀬Ŧ ???六욜춯?얠뒩????⑥щ턄??⑥ヂ??怨쀬Ŧ 嶺뚮ㅄ維??????逾??類ｋ뻤??????

