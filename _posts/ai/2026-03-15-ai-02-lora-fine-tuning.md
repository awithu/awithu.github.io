---
layout: post
title:  "LoRA嚥?LLM ???뵥??뺣뻼??띾┛: ??μ몛?怨몄뵥 筌뤴뫀????덈뮸 揶쎛??諭?
date:   2025-03-15 09:00:00 +0900
categories: [IT, AI]
tags: [AI, LLM, LoRA, ???뵥??뺣뻼, fine-tuning, Qwen, PEFT]
description: "LoRA???????뤿연 LLM????μ몛?怨몄몵嚥????뵥??뺣뻼??롫뮉 獄쎻뫖苡??獄쏄퀣??? ??쇱젫 ?꾨뗀諭???됱젫?????퉸 ??ｍ롨퉪袁⑥쨮 ??꾨퉸??몃빍??"
---

# LoRA嚥?LLM ???뵥??뺣뻼??띾┛: ??μ몛?怨몄뵥 筌뤴뫀????덈뮸 揶쎛??諭?

??域뱀뮆???紐꾨선 筌뤴뫀??LLM)?????뵥??뺣뻼??롫뮉 野껉퍔? ??쑴???筌띾‘???醫딅뼄. ?袁⑷퍥 筌뤴뫀?????덈뮸??쀪텕??삠늺 ??롪컶 GB??GPU 筌롫뗀?덄뵳?? ?袁⑹뒄??랁? ??덈뮸 ??볦퍢????살삋 椰꾨챶??? 

LoRA(Low-Rank Adaptation)???????얜챷?ｇ몴???욧퍙??롫뮉 ??μ몛?怨몄뵥 ???뵥??뺣뻼 疫꿸퀡苡???? ?袁⑷퍥 筌뤴뫀?????덈뮸??쀪텕?????? ?臾? ???????됱뵠??彛???덈뮸??뽱룖??筌롫뗀?덄뵳???????궢 ??덈뮸 ??볦퍢????苡?餓κ쑴???

??疫꼲?癒?퐣????쇱젫 ?꾨뗀諭띄몴????퉸 LoRA ???뵥??뺣뻼???袁⑷퍥 ?⑥눘?????ｍ롨퉪袁⑥쨮 ??꾨젫癰귣떯荑??

## LoRA?? ?얜똻毓?硫??

LoRA??筌뤴뫀???揶쎛餓λ쵐?귞몴?筌욊낯????륁젟??롫뮉 ???? **??筌△뫁????곗졊???곕떽?**??뤿연 筌뤴뫀????怨몄벓??쀪텕??疫꿸퀡苡???? 

?癒?삋 揶쎛餓λ쵐????곗졊 W????쇱벉??揶쏆늿???브쑵鍮??뺣뼄:

```
W' = W + ?W
?W = BA (B??r?엀, A??d?엛 ??곗졊, r << d)
```

??由??r?? rank嚥? 癰귣똾??8~64 ??????臾? 揶쏅???? ???껃칰???롢늺 ??덈뮸??곷튊 ??롫뮉 ???뵬沃섎챸苑???? 疫꿸퀬釉?묾?깅땾?怨몄몵嚥?餓κ쑴堉?醫딅뼄.

## ?袁⑷퍥 ?꾨뗀諭??닌듼?

?꾨뗀諭????苡???쇱벉??揶쏆늿? ??ｍ롦에??닌딄쉐??뺣뼄:

1. ?怨쀬뵠??嚥≪뮆諭?獄??袁⑹퓗??
2. 筌뤴뫀??獄??醫뤾쾿??륁뵠?? 嚥≪뮆諭?
3. LoRA ??쇱젟 ?怨몄뒠
4. ??덈뮸 ??쇱젟 獄???쎈뻬
5. 筌뤴뫀??????

揶???ｍ롧몴??癒?쉭????꾨젫癰귣똻??

## 1. ?袁⑹뒄????깆뵠?됰슢??뵳??袁る７??

```python
import argparse
import json
import os
from pathlib import Path

import torch
from datasets import Dataset
from peft import LoraConfig, get_peft_model
from transformers import AutoModelForCausalLM, Autotokizer
from trl import SFTConfig, SFTTrainer
```

- **argparse**: 筌뤿굝議듾빳??紐꾩쁽 ???뼓
- **torch**: PyTorch (?貫????袁⑥쟿?袁⑹뜖??
- **datasets**: Hugging Face ?怨쀬뵠?怨쀫???깆뵠?됰슢??뵳?
- **peft**: Parameter-Efficient Fine-Tuning ??깆뵠?됰슢??뵳?(LoRA ??釉?
- **transformers**: Hugging Face??筌뤴뫀???醫뤾쾿??륁뵠?? ??깆뵠?됰슢??뵳?
- **trl**: Transformer Reinforcement Learning (SFTTrainer ??釉?

## 2. ?怨쀬뵠??嚥≪뮆諭???λ땾

```python
def load_jsonl(path: Path) -> list[dict]:
    items = []
    with path.open("r", encoding="utf-8") as f:
        for line in f:
            if line.strip():
                items.append(json.loads(line))
    return items
```

????λ땾??JSONL(JSON Lines) ?類ㅻ뻼?????뵬????덈뮉?? JSONL?? 揶?餓κ쑴????끸뵲?怨몄뵥 JSON 揶쏆빘猿???類ㅻ뻼????

**??됰뻻 JSONL ???뵬:**
```
{"messages": [{"role": "user", "content": "??덈?}, {"role": "assistant", "content": "??덈??뤾쉭??"}]}
{"messages": [{"role": "user", "content": "???뵠?????몃Ŋ鍮?"}, {"role": "assistant", "content": "?袁⑥쨮域밸챶?믦쳸??紐꾨선??낅빍??"}]}
```

揶?餓κ쑴????뚮선??JSON??곗쨮 ???뼓??랁??귐딅뮞?紐꾨퓠 ?곕떽???뺣뼄.

## 3. 筌?쑵????쀫탣??癰궰????λ땾

```python
def build_chat_text(example: dict, tokizer: Autotokizer) -> str:
    """
    messages = [
      {"role": "user", "content": "..."},
      {"role": "assistant", "content": "..."}
    ]
    """
    messages = example["messages"]

    # Qwen / LLaMA ?④쑴肉?chat template ????
    text = tokizer.apply_chat_template(
        messages,
        tokize=False,
        add_generation_prompt=False,
    )
    return text
```

????λ땾??筌?쑵???類ㅻ뻼??筌롫뗄?놅쭪???筌뤴뫀?????꾨퉸??????덈뮉 ??용뮞?紐껋쨮 癰궰??묐립??

**??낆젾 ??됰뻻:**
```python
{
    "messages": [
        {"role": "user", "content": "??덈??뤾쉭??},
        {"role": "assistant", "content": "??덈??뤾쉭?? ?얜똻毓???袁???뺚뵭繹먮슣??"}
    ]
}
```

**?곗뮆????됰뻻 (Qwen ??쀫탣??:**
```
<|im_start|>user
??덈??뤾쉭??|im_end|>
<|im_start|>assistant
??덈??뤾쉭?? ?얜똻毓???袁???뺚뵭繹먮슣??<|im_end|>
```

`apply_chat_template`?? 筌뤴뫀???筌띿쉶???諭???醫뤾쿃???癒?짗??곗쨮 ?곕떽?????? `tokize=False`????용뮞???얜챷???곸뱽 獄쏆꼹???랁? `add_generation_prompt=False`????밴쉐 ?袁⑨세?袁る뱜???곕떽???? ??낅뮉??

## 4. 筌롫뗄????λ땾: ?紐꾩쁽 ???뼓

```python
def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--base_model", default="Qwen/Qwen2.5-7B-Instruct")
    parser.add_argument("--train_path", required=True)
    parser.add_argument("--eval_path", default="")
    parser.add_argument("--output_dir", required=True)

    parser.add_argument("--max_seq_length", type=int, default=2048)
    parser.add_argument("--learning_rate", type=float, default=1e-4)
    parser.add_argument("--num_train_epochs", type=int, default=3)
    parser.add_argument("--batch_size", type=int, default=1)
    parser.add_argument("--gradient_accumulation_steps", type=int, default=4)
    parser.add_argument("--save_steps", type=int, default=100)
    parser.add_argument("--logging_steps", type=int, default=10)
    parser.add_argument("--seed", type=int, default=42)

    # LoRA
    parser.add_argument("--lora_r", type=int, default=16)
    parser.add_argument("--lora_alpha", type=int, default=32)
    parser.add_argument("--lora_dropout", type=float, default=0.05)

    args = parser.parse_args()
```

筌뤿굝議듾빳??紐꾩쁽???類ㅼ벥??뺣뼄. 雅뚯눘???紐꾩쁽??

- **base_model**: ???뵥??뺣뻼??疫꿸퀡??筌뤴뫀??(疫꿸퀡??첎? Qwen2.5-7B-Instruct)
- **train_path**: ??덈뮸 ?怨쀬뵠??野껋럥以?(?袁⑸땾)
- **eval_path**: ??? ?怨쀬뵠??野껋럥以?(?醫뤾문)
- **output_dir**: 筌뤴뫀??????野껋럥以?(?袁⑸땾)
- **max_seq_length**: 筌ㅼ뮆? ??쀂???疫뀀챷??(?醫뤾쿃 ??
- **learning_rate**: ??덈뮸??
- **num_train_epochs**: ??덈뮸 ?癒곕７????
- **batch_size**: 獄쏄퀣????由?
- **gradient_accumulation_steps**: 域밸챶??遺용섧???袁⑹읅 ??쎈?(筌롫뗀?덄뵳??봔鈺???????
- **lora_r**: LoRA rank (?????롮쨯 ???뵬沃섎챸苑??怨몄벉, 疫꿸퀡??첎?16)
- **lora_alpha**: LoRA alpha (?????곗춦 ???뵬沃섎챸苑? 疫꿸퀡??첎?32)
- **lora_dropout**: LoRA dropout ??쑴??

## 5. GPU 筌롫뗀?덄뵳?筌ㅼ뮇?????쇱젟

```python
    os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "expandable_segments:True"
```

PyTorch??CUDA 筌롫뗀?덄뵳??醫딅뼣 獄쎻뫗???筌ㅼ뮇??酉釉?? `expandable_segments`??筌롫뗀?덄뵳????젶?遺? 餓κ쑴肉??????μ몛?怨몄몵嚥?GPU 筌롫뗀?덄뵳?? ?????????뉗쓺 ?????

## 6. ?醫뤾쾿??륁뵠?? 嚥≪뮆諭?

```python
    # tokizer ?믪눘? 嚥≪뮆諭?(chat template ????
    tokizer = Autotokizer.from_pretrained(
        args.base_model,
        trust_remote_code=True,
    )
    tokizer.pad_tok = tokizer.eos_tok
    padding_side_value = "right"
    tokizer.padding_side = padding_side_value
```

?醫뤾쾿??륁뵠?????믪눘? 嚥≪뮆諭??뺣뼄. `trust_remote_code=True`??筌뤴뫀????뚣끉??? ?꾨뗀諭띄몴???釉??野껋럩????쎈뻬????됱뒠??뺣뼄.

**餓λ쵐?????쇱젟:**
- `pad_tok = eos_tok`: ??ㅻ뎃 ?醫뤾쿃??EOS(End of Sequence) ?醫뤾쿃??곗쨮 ??쇱젟. ??? 筌뤴뫀??? ??ㅻ뎃 ?醫뤾쿃????곸뱽 ????덈뼄.
- `padding_side = "right"`: ??ㅻ뎃????삘뀲筌잛럩肉??곕떽?. ???봔?브쑴??筌뤴뫀?????獄쎻뫗????????뺣뼄.

## 7. ?怨쀬뵠?怨쀫?餓Β??

```python
    # dataset
    train_items = load_jsonl(Path(args.train_path))
    train_ds = Dataset.from_list(train_items)
    train_ds = train_ds.map(
        lambda ex: {"text": build_chat_text(ex, tokizer)},
        remove_columns=train_ds.column_names,
    )
```

??덈뮸 ?怨쀬뵠?怨? 嚥≪뮆諭??랁??袁⑹퓗?귐뗫립??

1. JSONL ???뵬????뚮선???귐딅뮞?紐껋쨮 癰궰??
2. Hugging Face Dataset 揶쏆빘猿쒏에?癰궰??
3. 揶???됱젫??筌?쑵????쀫탣???類ㅻ뻼??곗쨮 癰궰??
4. ?癒?궚 ?뚎됱쓥 ??볤탢 (筌롫뗀?덄뵳???됰튋)

**癰궰???⑥눘??**
```
?癒?궚: {"messages": [...]}
     ??
癰궰?? {"text": "<|im_start|>user\n??덈?|im_end|>\n..."}
```

??? ?怨쀬뵠?怨뺣즲 ??덉뵬??獄쎻뫗???곗쨮 筌ｌ꼶???뺣뼄:

```python
    eval_ds = None
    if args.eval_path:
        eval_items = load_jsonl(Path(args.eval_path))
        if eval_items:
            eval_ds = Dataset.from_list(eval_items)
            eval_ds = eval_ds.map(
                lambda ex: {"text": build_chat_text(ex, tokizer)},
                remove_columns=eval_ds.column_names,
            )
```

## 8. 疫꿸퀡??筌뤴뫀??嚥≪뮆諭?

```python
    # base model
    model = AutoModelForCausalLM.from_pretrained(
        args.base_model,
        torch_dtype=torch.float16,
        device_map="auto",
        trust_remote_code=True,
    )
```

疫꿸퀡??筌뤴뫀???嚥≪뮆諭??뺣뼄:

- **torch_dtype=torch.float16**: 獄쏆꼷?숃쳸???float16) ?????곗쨮 筌롫뗀?덄뵳????????덉뺘??곗쨮 揶쏅Ŋ??
- **device_map="auto"**: ?癒?짗??곗쨮 GPU/CPU??筌뤴뫀????브쑴沅?獄쏄퀣??(筌렺??GPU 筌왖??
- **trust_remote_code=True**: ?뚣끉??? 筌뤴뫀???꾨뗀諭???쎈뻬 ??됱뒠

## 9. LoRA ??쇱젟 ?怨몄뒠

```python
    # LoRA
    peft_config = LoraConfig(
        r=args.lora_r,
        lora_alpha=args.lora_alpha,
        lora_dropout=args.lora_dropout,
        bias="none",
        task_type="CAUSAL_LM",
        target_modules=[
            "q_proj", "k_proj", "v_proj",
            "o_proj", "gate_proj",
            "up_proj", "down_proj",
        ],
    )
    model = get_peft_model(model, peft_config)
    model.print_trainable_parameters()
```

LoRA ??쇱젟???類ㅼ벥??랁?筌뤴뫀????怨몄뒠??뺣뼄:

**LoRA ???뵬沃섎챸苑???살구:**
- **r (rank)**: ??筌△뫁????곗졊??筌△뫁?? ?臾믪뱽??롮쨯 ???뵬沃섎챸苑ｅ첎? ?怨?筌???쀬겱?關????λ선筌?????됱벉 (疫꿸퀡??첎? 16)
- **lora_alpha**: LoRA 揶쎛餓λ쵐????????곗춦 ??브숲. 癰귣똾??r??2獄쏄퀡以???쇱젟 (疫꿸퀡??첎? 32)
- **lora_dropout**: ??뺚댘?袁⑹뜍 ??쑴?? ?⑥눘???獄쎻뫗? (疫꿸퀡??첎? 0.05)
- **bias**: bias ??덈뮸 ???. "none"?? ??덈뮸??? ??놁벉
- **task_type**: ?臾믩씜 ?醫륁굨. "CAUSAL_LM"?? ?紐꾨선 筌뤴뫀?쏙쭕?
- **target_modules**: LoRA???怨몄뒠??筌뤴뫀諭? Attention??FFN??雅뚯눘????됱뵠??諭?

**target_modules ??살구:**
- `q_proj`, `k_proj`, `v_proj`: Query, Key, Value ?袁⑥쨮??밸?(Attention)
- `o_proj`: Output ?袁⑥쨮??밸?(Attention)
- `gate_proj`, `up_proj`, `down_proj`: Feed-Forward Network ??됱뵠??

`get_peft_model`嚥?筌뤴뫀?????묐릅??롢늺, 筌왖?類ｋ쭆 筌뤴뫀諭?癒?춸 LoRA ??됱뵠??? ?곕떽???뺣뼄. `print_trainable_parameters()`????덈뮸 揶쎛?館釉????뵬沃섎챸苑???? ?곗뮆???뺣뼄.

**??됰뻻 ?곗뮆??**
```
trainable params: 8,388,608 || all params: 6,738,415,616 || trainable%: 0.12
```

?袁⑷퍥 筌뤴뫀???0.12%筌???덈뮸???嚥?筌롫뗀?덄뵳?? ??볦퍢????苡???됰튋??뺣뼄.

## 10. ??덈뮸 ??쇱젟

```python
    # SFT config
    training_args = SFTConfig(
        output_dir=args.output_dir,
        dataset_text_field="text",
        max_length=args.max_seq_length,
        packing=False,
        num_train_epochs=args.num_train_epochs,
        per_device_train_batch_size=args.batch_size,
        gradient_accumulation_steps=args.gradient_accumulation_steps,
        optim="paged_adamw_32bit",
        save_steps=args.save_steps,
        logging_steps=args.logging_steps,
        learning_rate=args.learning_rate,
        warmup_ratio=0.03,
        lr_scheduler_type="cosine",
        seed=args.seed,
        report_to=[],
    )
```

SFT(Supervised Fine-Tuning) ??덈뮸 ??쇱젟:

**雅뚯눘????쇱젟:**
- **dataset_text_field**: ?怨쀬뵠?怨쀫?癒?퐣 ???????용뮞???袁⑤굡筌?
- **max_length**: 筌ㅼ뮆? ??쀂???疫뀀챷??(?醫뤾쿃 ??
- **packing**: ??????됱젫????롪돌????쀂???살쨮 ???때?醫? ??? (False??揶???됱젫????끸뵲?怨몄몵嚥?筌ｌ꼶??
- **per_device_train_batch_size**: ?遺얠뺍??곷뮞??獄쏄퀣????由?
- **gradient_accumulation_steps**: 域밸챶??遺용섧???袁⑹읅. 獄쏄퀣????由곁몴???ｋ궢?怨몄몵嚥???쇱뒻 ????됱벉
  - ??쇱젫 獄쏄퀣????由?= batch_size ??gradient_accumulation_steps ??num_gpus
- **optim**: ???뼒筌띾뜆???. "paged_adamw_32bit"??筌롫뗀?덄뵳???μ몛?怨몄뵥 AdamW
- **warmup_ratio**: ???빪????쑴??(?袁⑷퍥 ??쎈??3%)
- **lr_scheduler_type**: ??덈뮸?????餓κ쑬?? "cosine"?? ?꾨뗄沅??揶쏅Ŋ??
- **report_to**: 嚥≪뮄??????(???귐딅뮞?紐껊뮉 嚥≪뮄??????

## 11. ?紐껋쟿??瑗???밴쉐 獄???덈뮸

```python
    trainer = SFTTrainer(
        model=model,
        tokizer=tokizer,
        train_dataset=train_ds,
        eval_dataset=eval_ds,
        peft_config=peft_config,
        args=training_args,
    )

    print("Starting chat SFT training...")
    trainer.train()
```

SFTTrainer????밴쉐??랁???덈뮸????뽰삂??뺣뼄. SFTTrainer??Hugging Face??Trainer???類ㅼ삢??뤿연 ??용뮞????밴쉐 筌뤴뫀????덈뮸??筌ㅼ뮇??遺얜쭆 疫꿸퀡?????볥궗??뺣뼄.

??덈뮸????뽰삂??롢늺 ??쇱벉??揶쏆늿? ?類ｋ궖揶쎛 ?곗뮆???뺣뼄:
- ??덈뮸 ?癒?뼄 (loss)
- ??덈뮸??(learning rate)
- ??덈뮸 ??얜즲 (samples/sec)
- ??? ??볦퍢 (estimated time)

## 12. 筌뤴뫀??????

```python
    out_dir = Path(args.output_dir)
    out_dir.mkdir(parents=True, exist_ok=True)
    trainer.model.save_pretrained(out_dir)
    tokizer.save_pretrained(out_dir)
```

??덈뮸???袁⑥┷??롢늺 筌뤴뫀?썸??醫뤾쾿??륁뵠???????館釉?? LoRA 筌뤴뫀??? 疫꿸퀡??筌뤴뫀?썸??????揶쎛餓λ쵐?귨쭕????貫由븃첋?嚥???몄쎗??筌띲끉???臾먮뼄 (癰귣똾????뤿뼏 MB).

## ??????됰뻻

?꾨뗀諭띄몴???쎈뻬??롫뮉 獄쎻뫖苡?

```bash
python train_lora.py \
    --base_model Qwen/Qwen2.5-7B-Instruct \
    --train_path data/train.jsonl \
    --eval_path data/eval.jsonl \
    --output_dir ./output \
    --max_seq_length 2048 \
    --learning_rate 1e-4 \
    --num_train_epochs 3 \
    --batch_size 1 \
    --gradient_accumulation_steps 4 \
    --lora_r 16 \
    --lora_alpha 32
```

## LoRA ???뵬沃섎챸苑???뺣뻼 揶쎛??諭?

**rank (r) ?醫뤾문:**
- **r=8**: 筌띲끉???怨? ???뵬沃섎챸苑? ??쥓????덈뮸, ??? ??쀬겱??
- **r=16**: 域뱀쥚???レ뿺 ?醫뤾문 (疫꿸퀡??첎?
- **r=32**: ??筌띾‘? ???뵬沃섎챸苑? ???誘? ??쀬겱??
- **r=64**: 筌띾‘? ???뵬沃섎챸苑? ?誘? ??쀬겱?? ?癒?뵛 ??덈뮸

**alpha ?醫뤾문:**
- 癰귣똾??r??2獄쏄퀡以???쇱젟 (r=16????alpha=32)
- alpha揶쎛 ??곷땾嚥?LoRA 揶쎛餓λ쵐????怨밸샨???뚣끉彛?

**筌롫뗀?덄뵳??봔鈺???**
- `batch_size`??1嚥???쇱젟
- `gradient_accumulation_steps`????롮젻????쇱젫 獄쏄퀣????由??醫?
- `max_seq_length`??餓κ쑴??
- `lora_r`??餓κ쑴??

## ?袁⑷퍥 ?꾨뗀諭?

?袁⑷퍥 ?꾨뗀諭???袁⑹벥 ??ｍ??쇱뱽 筌뤴뫀紐???釉??뺣뼄. 揶??봔?브쑴????堉멨칰??怨뚭퍙??롫뮉筌왖 ??꾨퉸??롢늺, ?癒?뻿筌띾슣?????뵥??뺣뻼 ???뵠?袁⑥뵬?紐꾩뱽 ?닌딇뀧??????덈뼄.

## 野껉퀡以?

LoRA???????롢늺 ?袁⑷퍥 筌뤴뫀?????덈뮸??쀪텕??野껉퍓?????λ뎌 ?怨? ?귐딅꺖??살쨮 LLM?????뵥??뺣뻼??????덈뼄. ???꾨뗀諭????쇱젫 ?袁⑥쨮?類ㅻ?癒?퐣 ?????????덈뮉 ??????袁⑹읈????됱젫??

雅뚯눘???關??
- **筌롫뗀?덄뵳???μ몛**: ?袁⑷퍥 筌뤴뫀??????1% 沃섎챶彛?????뵬沃섎챸苑ｏ쭕???덈뮸
- **??덈뮸 ??얜즲**: ??쥓????롮죨??筌욁룂? ??덈뮸 ??볦퍢
- **?醫롫염??*: ?????臾믩씜????????뺤쨮 ??삘뀲 LoRA ????怨? ??덈뮸 揶쎛??
- **?紐낆넎??*: 疫꿸퀡??筌뤴뫀??? 域밸챶?嚥??醫???롢늺??????怨뺤춸 ?대Ŋ猿?揶쎛??

???꾨뗀諭띄몴?疫꿸퀡而??곗쨮 ?癒?뻿筌띾슣???怨쀬뵠?怨쀫??곗쨮 筌뤴뫀??????뵥??뺣뻼?????

